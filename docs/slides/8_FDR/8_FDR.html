<!DOCTYPE html>
<html>
  <head>
    <title>The False Discovery Rate</title>
    <meta charset="utf-8">
    <meta name="author" content="Aldo Solari" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# <strong>The False Discovery Rate</strong>
### Aldo Solari

---





# Outline

* False Discovery Rate

* Benjamini-Hochberg

* Benjamini-Yekutieli


---

# An alternative to the FWER

* The **False Discovery Rate** (FDR) is an an error control criterion developed in the 90's as an alternative to the FWER, which is usually employed in small-scale testing

* Now we are testing millions of hypotheses at once, and making a false discovery is not the end of the world

* The concept of FDR has changed thinking about multiple testing quite radically, showing that FWER control is not only way to do of multiple testing, and stimulating the field of multiple testing enormously

* FDR was introduced by Benjamini and Hochberg in 1995, and currently has 50K citations

* It is one of the [most-cited research of all time](https://www.nature.com/news/the-top-100-papers-1.16224)

---

# The False Discovery Rate

* The outcome of multiple testing is

|   | true  | false  | total  | 
|---|---|---|---|
| rejected  | `\(V\)`  | `\(U\)`  |  `\(R\)` |
| not rejected   | `\(m_0-V\)`  |  `\(m_1-U\)`  | `\(m-R\)`   |
| total  | `\(m_0\)`  | `\(m_1\)`  | `\(m\)`  |

* The **false discovery proportion** (FDP) is defined as
`$$Q = \frac{V}{\max(R,1)}$$`
which is the proportion of false rejections among the rejections, defined as 0 if no rejections are made 

* The **false discovery rate** (FDR) is defined as
$$
\mathrm{FDR} = \mathbb{E}(Q)
$$

---

# FWER and FDR

* We have
$$
\mathrm{FWER} = \mathrm{P}(V &gt; 0) = \mathrm{P}(Q &gt; 0) \qquad \mathrm{vs} \qquad \mathrm{FDR} = \mathbb{E}(Q)
$$

* The two error rates FDR and FWER are related. Because `\(0 \leq Q \leq 1\)`, we have `$$\mathbb{E}(Q) \leq \mathrm{Pr}(Q&gt;0)$$` which implies that every FWER-controlling method is automatically also an FDR-controlling method

* Because FDR is smaller than FWER,  it is easier to keep the FDR below a level `\(\alpha\)` than to keep the FWER below the same level, and we can generally expect FDR-based methods to have more power than FWER-based
ones

* Conversely, if all hypotheses are true, FDR and FWER are identical; because `\(R=V\)` in this case, `\(Q\)` is a Bernoulli random variable, and `\(\mathbb{E}(Q) = \mathrm{Pr}(Q &gt;0)\)`

* Both FDR and FWER are proper generalizations of the concept of type I error to multiple hypotheses; if there is only one hypothesis ( `\(m=1\)` ) the two error rates are identical, and equal to the regular type I error

---

* `\(Z_i \sim N(\mu_i,1)\)` is the test statistic

* `\(H_i: \mu_i = 0\)` vs `\(\bar{H}_i: \mu_i &gt; 0\)`

* Reject `\(H_i\)` if `\(p_i = 1-\Phi(Z_i) \leq \alpha\)`


```r
sim &lt;- function(m, m0, effect) {
alpha = 0.05
stats &lt;- rnorm(m)
stats[(m0+1):m] &lt;- stats[(m0+1):m] + effect
pvals = pnorm(stats, lower.tail = FALSE)
setR &lt;- which(pvals &lt;= alpha)
# number of rejections
R = length(setR)
# number of type I errors
V &lt;- sum( setR &lt;= m0 )
# family-wise error
FWE &lt;- (V &gt; 0)
# false discovery proportion
FDP &lt;- V/max(1,R)
return(c(R, V, FWE, FDP))
}
```

---


```r
set.seed(123)
res &lt;- replicate(10, sim(100, 80, 2))
row.names(res) &lt;- c("R","V","V&gt;0", "V/R")
res
```

```
    [,1]       [,2]       [,3]    [,4]  [,5]    [,6] [,7]       [,8]  [,9]      [,10]
R   20.0 17.0000000 23.0000000 16.0000 20.00 16.0000 15.0 17.0000000 20.00 17.0000000
V    4.0  5.0000000  6.0000000  5.0000  5.00  3.0000  3.0  5.0000000  7.00  4.0000000
V&gt;0  1.0  1.0000000  1.0000000  1.0000  1.00  1.0000  1.0  1.0000000  1.00  1.0000000
V/R  0.2  0.2941176  0.2608696  0.3125  0.25  0.1875  0.2  0.2941176  0.35  0.2352941
```

---


```r
set.seed(123)
res &lt;- replicate(1000, sim(100, 80, 2))
rowMeans(res[3:4,]) # FWER and FDR
```

```
[1] 0.988000 0.230645
```

---

# Benjamini and Hochberg (1995) 

* Fix a level `\(\alpha \in (0,1)\)`

* Begin by ordering the p-values in ascending order
`$$p_{(1)}\leq p_{(2)}\leq \ldots \leq p_{(m)}$$`

* Let `\(i_{max}\)` be be the largest `\(i\)` for which
`$$p_{(i)} \leq \frac{i \alpha}{m}$$`

* Reject all `\(H_{(i)}\)` with `\(i \leq i_{max}\)`

---

# BH controls the FDR

* For null p-values i.i.d `\(\mathrm{Uniform}(0,1)\)`, the Benjamini-Hochberg (BH) procedure controls the FDR at level `\(\alpha\)`. More precisely
`$$\mathrm{FDR} = \frac{m_0}{m} \alpha \leq \alpha$$`

* An interesting note is that the BH threshold is adaptive; it depends on the specific values of `\(p_{(1)} \leq p_{(2)}\leq \ldots \leq p_{(n)}\)`

* However, the BH procedure fails to control the FWER at `\(\alpha\)`

---


```r
sim &lt;- function(m, m0, effect) {
alpha = 0.05
stats &lt;- rnorm(m)
stats[(m0+1):m] &lt;- stats[(m0+1):m] + effect
pvals = pnorm(stats, lower.tail = FALSE)
setR &lt;- which(p.adjust(pvals,"BH") &lt;= alpha)
# number of rejections
R = length(setR)
# number of type I errors
V &lt;- sum( setR &lt;= m0 )
# family-wise error
FWE &lt;- (V &gt; 0)
# false discovery proportion
FDP &lt;- V/max(1,R)
return(c(R, V, FWE, FDP))
}
```

---


```r
set.seed(123)
res &lt;- replicate(20, sim(100, 80, 2))
row.names(res) &lt;- c("R","V","V&gt;0", "V/R")
res
```

```
    [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]     [,12] [,13] [,14] [,15] [,16] [,17] [,18] [,19]     [,20]
R      6 4.00    8    2    7    2    4    0    2     4  8.00 6.0000000     2  4.00    11     2   5.0     3     8 6.0000000
V      0 1.00    0    0    0    0    0    0    0     0  2.00 1.0000000     0  1.00     0     0   1.0     0     0 1.0000000
V&gt;0    0 1.00    0    0    0    0    0    0    0     0  1.00 1.0000000     0  1.00     0     0   1.0     0     0 1.0000000
V/R    0 0.25    0    0    0    0    0    0    0     0  0.25 0.1666667     0  0.25     0     0   0.2     0     0 0.1666667
```

---


```r
set.seed(123)
res &lt;- replicate(1000, sim(100, 80, 2))
rowMeans(res[3:4,]) # FWER and FDR
```

```
[1] 0.19300000 0.03960009
```

---

# FDR interpretation

* Consider what it means to control FDR: if we repeat our experiment many times, on average we control the FDP

* This is not a statement about our individual experiment, and does not say much
about the chance of having our FDP exceed a certain threshold other than the very weak bound
we can obtain via Markov's inequality:

`$$\Pr(Q &gt; \gamma) \leq \frac{\mathbb{E}(Q)}{\gamma}$$`

* FWER, on the other hand, does control for an individual experiment. That is, with FWER control, we have no false discoveries unless we are very unlucky; with FDR control, on average our test will control FDP, but *this time* we may not have done a very good job

---

# Benjamini-Yekutieli (2001)

Under general dependence, the BH procedure controls at level `\(\alpha S(n)\)`, with 
`$$S(m) = \sum_{i=1}^{m}\frac{1}{i} =  1 + 1/2 + 1/3 + \ldots + 1/m \approx \log m + 0.577$$`
In fact
`$$\mathrm{FDR} \leq \frac{m_0}{m} S(m)\alpha$$`

The Benjamini-Yekutieli procedure (BY) finds `\(i_{max}\)` be be the largest `\(i\)` for which
`$$p_{(i)} \leq \frac{i \alpha}{m S(m)}$$`
and rejects all `\(H_{(i)}\)` with `\(i \leq i_{max}\)`

---

# Positive regression dependence

* BH procedure controls the FDR under a notion of positive correlation between p-values. This form of dependence is known as *positive regression dependence on the subset of p-values of true null hypotheses* (PRDS)

* If the joint distribution of the `\(p\)`-values is PRDS, then the BH procedure controls the FDR at level `\(\frac{m_0}{m}\alpha\)`
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightLanguage": "R",
"countIncrementalSlides": false,
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
